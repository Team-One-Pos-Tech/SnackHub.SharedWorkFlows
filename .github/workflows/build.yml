name: Snackhub's shared build workflow

on:
  workflow_call:
    inputs:
      solution-name:
        required: true
        type: string
        description: "Service solution's name(.sln file)!"
      api-project-name:
        required: true
        type: string
        description: "Api project or runtime target project(eg: SnackHub.Api.csproj)"
      sonar-project-key:
        required: true
        type: string
        description: "Project key configured at SonarCloud for the target project"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies â‡£
        run: dotnet restore ${{inputs.solution-name}}

      - name: Publishing âš™
        run: dotnet publish src/${{inputs.api-project-name}}/${{inputs.api-project-name}}.csproj -c Release -o release/output

      - name: Archive publish artifacts ðŸ“¦
        uses: actions/upload-artifact@v4
        with:
          name: release-binaries
          path: release/output
      
      #      - name: Test execution ðŸ§ª
      #        run: dotnet test ${{inputs.solution-name}} --verbosity minimal --collect:"Code Coverage;Format=cobertura" --results-directory "test-results" --logger trx --collect:"XPlat Code Coverage" -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover

      - name: Archive test reports ðŸ“¦
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: test-results
  
  tests-and-quality:
    uses: highbyte/sonarscan-dotnet@v2.3.3
    with:
      sonarProjectKey: ${{inputs.sonar-project-key}}
      sonarProjectName: ${{ inputs.sonar-project-name }}
      sonarOrganization: ${{ github.repository_owner }}
      dotnetTestArguments: >-
        --logger trx --collect:"XPlat Code Coverage" --
        DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
      sonarBeginArguments: >-
        /d:sonar.cs.opencover.reportsPaths="**/TestResults/**/coverage.opencover.xml"
        -d:sonar.cs.vstest.reportsPaths="**/TestResults/*.trx"
    env:
      SONAR_TOKEN: '${{ secrets.SONAR_TOKEN }}'
      GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'